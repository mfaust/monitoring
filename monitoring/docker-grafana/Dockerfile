
FROM docker-alpine-base:latest

MAINTAINER Bodo Schulz <bodo.schulz@coremedia.com>

LABEL version="2.3.0"

# 3000: grafana (plain)
EXPOSE 3000

ENV GOPATH=/opt/go
ENV GO15VENDOREXPERIMENT=0

# ---------------------------------------------------------------------------------------

RUN \
  apk --quiet update

RUN \
  apk --quiet add \
    build-base \
    nodejs \
    go \
    git \
    mercurial \
    netcat-openbsd \
    pwgen \
    jq \
    yajl-tools \
    mysql-client \
    sqlite

RUN \
  go get github.com/grafana/grafana || true

RUN \
  cd $GOPATH/src/github.com/grafana/grafana && \
  go run build.go setup && \
  $GOPATH/bin/godep restore && \
  go run build.go build && \
  npm install && \
  npm install -g grunt-cli && \
  grunt

RUN \
  mkdir -p /usr/share/grafana/bin/ && \
  cp -a  $GOPATH/src/github.com/grafana/grafana/bin/grafana-cli    /usr/share/grafana/bin/ && \
  cp -a  $GOPATH/src/github.com/grafana/grafana/bin/grafana-server /usr/share/grafana/bin/ && \
  cp -ar $GOPATH/src/github.com/grafana/grafana/public_gen         /usr/share/grafana/public && \
  cp -ar $GOPATH/src/github.com/grafana/grafana/conf               /usr/share/grafana/

RUN \
  mkdir /var/log/grafana && \
  mkdir /var/log/supervisor

RUN \
  /usr/share/grafana/bin/grafana-cli --pluginsDir "/usr/share/grafana/data/plugins" plugins install grafana-clock-panel && \
  /usr/share/grafana/bin/grafana-cli --pluginsDir "/usr/share/grafana/data/plugins" plugins install grafana-piechart-panel && \
  /usr/share/grafana/bin/grafana-cli --pluginsDir "/usr/share/grafana/data/plugins" plugins install grafana-simple-json-datasource && \
  /usr/share/grafana/bin/grafana-cli --pluginsDir "/usr/share/grafana/data/plugins" plugins install raintank-worldping-app

RUN \
  npm uninstall -g grunt-cli && \
  npm cache clear && \
  go clean -i -r && \
  apk del --purge \
    build-base \
    nodejs \
    go \
    git \
    mercurial && \
  rm -rf $GOPATH /tmp/* /var/cache/apk/* /root/.n* /usr/local/bin/phantomjs

ADD rootfs/ /

VOLUME [ "/usr/share/grafana/data" "/usr/share/grafana/public/dashboards" "/opt/grafana/dashboards" ]

WORKDIR /usr/share/grafana

ENTRYPOINT [ "/opt/startup.sh" ]

# EOF
