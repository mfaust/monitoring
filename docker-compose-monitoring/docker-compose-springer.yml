---
# project_name: monitoring
version: '2.0'

networks:
  mon:
    driver: bridge
    ipam:
      config:
      - subnet: 172.25.0.0/24

services:
  database:
    restart: always
    image: bodsch/docker-mysql:1610-02
    container_name: database
    hostname: database
    env_file:
      - env/database.env
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./data:/srv
    networks:
      mon:
        ipv4_address: 172.25.0.10

  jolokia:
    restart: always
    image: bodsch/docker-jolokia:1610-02
    container_name: jolokia
    hostname: jolokia
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./share/resolv.conf:/etc/resolv.conf:ro
    ports:
      - 8080:8080
    extra_hosts:
      - 'blueprint-box:192.168.252.100'
    networks:
      mon:
        ipv4_address: 172.25.0.11

  memcached:
    restart: always
    image: bodsch/docker-memcached:1610-02
    container_name: memcached
    hostname: memcached
    volumes:
      - /etc/localtime:/etc/localtime:ro
    networks:
      mon:
        ipv4_address: 172.25.0.12

  nginx:
    restart: always
    image: bodsch/docker-nginx:1610-02
    container_name: nginx
    hostname: nginx
    ports:
      - 80:80
    depends_on:
      - grafana
      - icingaweb2
      - cm-monitoring
    extra_hosts:
      - 'jolokia:172.25.0.11'
      - 'grafana:10.101.2.100'
      - 'cm-monitoring:172.25.0.40'
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./share/nginx/var/www:/var/www:ro
      - ./share/nginx/etc/nginx/sites-enabled:/etc/nginx/sites-enabled:ro
      - ./share/nginx/etc/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./share/nginx/etc/nginx/modules.d/00-restrictions.conf:/etc/nginx/modules.d/00-restrictions.conf:ro
      - ./share/nginx/etc/nginx/modules.d/01-proxy-grafana.conf:/etc/nginx/modules.d/01-proxy-grafana.conf:ro
      - ./share/nginx/etc/nginx/modules.d/01-proxy-rest-service.conf:/etc/nginx/modules.d/01-proxy-rest-service.conf:ro
    networks:
      mon:
        ipv4_address: 172.25.0.15

  # support a carbon-relay container
  # we have now a second 'carbon-relay-ng' for testing
  carbon-relay:
    restart: always
    image: bodsch/docker-carbon-c-relay:1610-02
    container_name: carbon-relay
    hostname: carbon-relay
    ports:
      - 2003:2003
    env_file:
      - env/carbon-relay.env
    extra_hosts:
      - 'graphite:10.101.2.100'
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./share/carbon-relay/etc/supervisor.d/carbon-relay.ini:/etc/supervisor.d/carbon-relay.ini:ro
    networks:
      mon:
        ipv4_address: 172.25.0.20

  cm-monitoring:
    restart: always
    build: ../docker-cm-monitoring
    container_name: cm-monitoring
    hostname: cm-monitoring
    env_file:
      - env/cm-monitoring.env
    depends_on:
      - jolokia
      - carbon-relay
      - memcached
    extra_hosts:
      - 'jolokia:172.25.0.11'
      - 'memcached:172.25.0.12'
      - 'carbon-relay:172.25.0.20'
      - 'grafana:10.101.2.100'
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./share/resolv.conf:/etc/resolv.conf:ro
      - ./data/monitoring:/var/cache/monitoring
      - ./data:/srv
    links:
      - jolokia:jolokia
    networks:
      mon:
        ipv4_address: 172.25.0.40
