#!/bin/bash
#
# CM7-License
#
#

# ----------------------------------------------------------------------------------------

SCRIPTNAME=$(basename $0 .sh)
VERSION="1.1.1"
VDATE="10.02.2015"

# ----------------------------------------------------------------------------------------

NRPE_DEFAULTS="/usr/local/share/nrpe_defaults.sh"

[ -f "${NRPE_DEFAULTS}" ] && {
  . ${NRPE_DEFAULTS}
} || {
  echo "nrpe defaults missing"
  exit 1
}

# [ -f /usr/local/share/nrpe_defaults.sh ] && . /usr/local/share/nrpe_defaults.sh

WARN=50
CRIT=15

# ----------------------------------------------------------------------------------------

LICENSE_CACHE="${TMP_DIR}/license.cache"
LICENSE_MD5="${TMP_DIR}/license.md5"
HOSTNAME=
CM_TOOL=
CM_LICENSE=

# ----------------------------------------------------------------------------------------

prepare() {

  HOSTNAME="$(hostname -s)"

  if [[ ${HOSTNAME} =~ .*cms.* ]] # dmz-cm-cms-prod-01-vi
  then
    APPLICATION="cm7-cms"
  elif [[ ${HOSTNAME} =~ .*mls.* ]]
  then
    APPLICATION="cm7-mls"
  elif [[ ${HOSTNAME} =~ .*rls.* ]]
  then
    APPLICATION="cm7-rls"
  else
    echo "unknown Application"
    exit ${STATE_UNKNOWN}
  fi

  CM_TOOL="/opt/coremedia/${APPLICATION}-tools/bin/cm"
  CM_LICENSE="/etc/coremedia/${APPLICATION}-license/license.zip"
}

buildCache() {

  export JAVA_HOME=/usr/java/latest

  if [ ! -f ${LICENSE_MD5} ]
  then
    md5sum ${CM_LICENSE} | cut -c 1-32 > ${LICENSE_MD5}
  else
    MD5="$(cat ${LICENSE_MD5})"
    FILE="$(md5sum ${CM_LICENSE} | cut -c 1-32)"

    # pruefen, ob eine neue Lizenzdatei vorliegt
    if [ "${MD5}" != "${FILE}" ]
    then
      rm -f ${LICENSE_MD5}
      rm -f ${LICENSE_CACHE}

      md5sum ${CM_LICENSE} | cut -c 1-32 > ${LICENSE_MD5}
    fi
  fi

  if [ ! -f ${LICENSE_CACHE} ]
  then
    ${CM_TOOL} license -u webserver -p webserver > ${LICENSE_CACHE}
  fi
}

echoResult() {

  UNTIL="$(cat ${LICENSE_CACHE} | grep 'valid until' | awk '{print $3}' | awk -F'T' '{print $1}' )" # 2015-07-15T02:00:00+02:00

  if [ -z ${UNTIL} ]
  then
    echo "CRITICAL - CM License has no valid License-Date"

    rm -f ${LICENSE_MD5}
    rm -f ${LICENSE_CACHE}

    exit ${STATE_CRITICAL}
  fi

  DEADLINE="$(expr '(' $(date -d ${UNTIL} +%s) - $(date +%s) + 86399 ')' / 86400)"

  UNTIL="$(date +%d.%m.%Y --date="${UNTIL}")"

  if ( [ ${DEADLINE} -gt ${WARN} ] || [ ${DEADLINE} -eq ${WARN} ] )
  then
    echo "OK - CM License is valid until ${UNTIL} - ${DEADLINE} days left"
    exit ${STATE_OK}
  elif ( [ ${DEADLINE} -gt ${CRIT} ] && [ ${DEADLINE} -lt ${WARN} ] )
  then
    echo "WARNING - CM License is valid until ${UNTIL} - ${DEADLINE} days left"
    exit ${STATE_WARNING}
  elif [ ${DEADLINE} -lt ${CRIT} ]
  then
    echo "CRITICAL - CM License is valid until ${UNTIL} - ${DEADLINE} days left"
    exit ${STATE_CRITICAL}
  fi
}

run() {

  prepare

  buildCache

  echoResult
}


run

exit 0

# EOF
